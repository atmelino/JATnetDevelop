<!doctype html>
<html lang="en">
<head>
<title>GUI (Three.js)</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<link rel=stylesheet href="../lib/css/base.css" />
<link rel=stylesheet href="../lib/css/jquery-ui.css" />
<link rel=stylesheet href="../lib/css/info.css" />

<script src="../lib/js/Three.js"></script>
<script src="../lib/js/Detector.js"></script>
<script src="../lib/js/Stats.js"></script>
<script src="../lib/js/OrbitControls.js"></script>
<!-- <script src="../lib/js/TrackballControls.js"></script> -->
<script src="../lib/js/THREEx.KeyboardState.js"></script>
<script src="../lib/js/THREEx.FullScreen.js"></script>
<script src="../lib/js/THREEx.WindowResize.js"></script>
<script src='../lib/js/DAT.GUI.min.js'></script>
<script src="../lib/js/jquery-1.9.1.js"></script>
<script src="../lib/js/jquery-ui.js"></script>
<script src="../lib/js/info.js"></script>
<script src="../lib/fonts/gentilis_bold.typeface.js"></script>
<script src="../lib/fonts/gentilis_regular.typeface.js"></script>
<script src="../lib/fonts/optimer_bold.typeface.js"></script>
<script src="../lib/fonts/optimer_regular.typeface.js"></script>
<script src="../lib/fonts/helvetiker_bold.typeface.js"></script>
<script src="../lib/fonts/helvetiker_regular.typeface.js"></script>
<script src="../lib/fonts/droid_sans_regular.typeface.js"></script>
<script src="../lib/fonts/droid_sans_bold.typeface.js"></script>
<script src="../lib/fonts/droid_serif_regular.typeface.js"></script>
<script src="../lib/fonts/droid_serif_bold.typeface.js"></script>

<script src="../lib/js/extra/grid.js"></script>
<script src="../lib/js/extra/axisLabels.js"></script>
<script src="../lib/js/extra/colors.js"></script>

<!-- Coordinate order has been changed to reflect OpenGL default: -->
<!-- first coordinate is y -->
<!-- second coordinate is z -->
<!-- third coordinate is x -->

<script>
	// MAIN
	// standard global variables
	var container, scene, camera, renderer, controls, stats;
	var keyboard = new THREEx.KeyboardState();
	var clock = new THREE.Clock();

	// custom global variables
	var cube;
	var radius = 6370;
	var gridSize = 10000;
	//var radius = 100;
	//var gridSize = 200;
	var parameters;
	var gui;
	var zUpVec = [ 0, 0, 0 ];
	var autoRotateCB;
	var lines = new Array();
	var satellite;
	var satScale = 100;

	function setup() {
		// initialization
		init();

		// animation loop / game loop
		animate();

	}

	// FUNCTIONS 		
	function init() {
		// SCENE
		scene = new THREE.Scene();

		// CAMERA
		var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
		var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 1000 * gridSize;
		camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
		scene.add(camera);
		camera.position.set(radius * 5, 3.5 * radius, 4 * radius);
		//camera.position.set([radius * 5, 3.5 * radius, 4 * radius]);
		camera.lookAt(scene.position);

		// RENDERER
		if (Detector.webgl)
			renderer = new THREE.WebGLRenderer({
				antialias : true
			});
		else
			renderer = new THREE.CanvasRenderer();
		renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
		container = document.getElementById('ThreeJS');
		container.appendChild(renderer.domElement);

		// EVENTS
		THREEx.WindowResize(renderer, camera);
		THREEx.FullScreen.bindKey({
			charCode : 'm'.charCodeAt(0)
		});

		// CONTROLS
		controls = new THREE.OrbitControls(camera, renderer.domElement);
		//controls = new THREE.TrackballControls( camera, renderer.domElement );
		controls.autoRotate = true;
		controls.autoRotateSpeed = 0.2;

		// STATS
		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.bottom = '0px';
		stats.domElement.style.zIndex = 100;
		container.appendChild(stats.domElement);

		// LIGHT
		var light = new THREE.PointLight(0xffffff);
		light.position.set(0, 250, 0);
		scene.add(light);

		// GUI
		gui = new dat.GUI();
		parameters = {
			a : 12000, // numeric
			ecc : 0.3, // numeric slider
			inc : 23, // numeric slider
			raan : 10, // numeric slider
			w : 10, // numeric slider
			ta : 10, // numeric slider
			add : makeOrbit,
			clear : clearOrbits,
			autoRotate : false, // boolean (checkbox)
			opacity : 0.8, // numeric slider
			satScale : 100,
			background : "Stars",
		};
		gui.add(parameters, 'a').min(6000).max(50000).step(1).name('Semimajor Axis [km]');
		gui.add(parameters, 'ecc').min(0).max(1).step(0.01).name('Eccentricity');
		gui.add(parameters, 'inc').min(0).max(180).step(0.1).name('Inclination');
		gui.add(parameters, 'raan').min(0).max(180).step(0.1).name('RAAN');
		gui.add(parameters, 'w').min(0).max(180).step(0.1).name('Perigee');
		gui.add(parameters, 'ta').min(0).max(180).step(0.1).name('True Anomaly');
		gui.add(parameters, 'add').name('Add Orbit');
		gui.add(parameters, 'clear').name('Clear Orbit(s)');
		//gui.add(parameters, 'autoRotate').name('autoRotate');
		autoRotateCB = gui.add(parameters, 'autoRotate').name('autoRotate').listen();
		autoRotateCB.onChange(function(value) {
			//console.log(value);
			controls.autoRotate = value;
		});
		var opacity = gui.add(parameters, 'opacity').min(0).max(1).step(0.01).name('Opacity').listen();
		opacity.onChange(function(value) {
			earthSphere.material.opacity = value;
		});
		var satScale = gui.add(parameters, 'satScale').min(1).max(1000).step(1).name('satellite scale').listen();
		satScale.onChange(function(value) {
			satellite.scale.set(value, value, value);
		});
		var bgList = [ "Color", "Stars", "Sky" ];
		gui.add(parameters, 'background', bgList).name('background');

		gui.open();

		// SKYBOX/FOG
		var skyBoxGeometry = new THREE.CubeGeometry(1000 * gridSize, 1000 * gridSize, 1000 * gridSize);
		var skyBoxMaterial = new THREE.MeshBasicMaterial({
			color : 0x9999ff,
			side : THREE.BackSide
		});
		var skyBox = new THREE.Mesh(skyBoxGeometry, skyBoxMaterial);
		//scene.add(skyBox);
		//scene.fog = new THREE.FogExp2(0x9999ff, 0.00025);

		// SPACEBOX
		var imagePrefix = "../lib/images/nebula-";
		var directions = [ "xpos", "xneg", "ypos", "yneg", "zpos", "zneg" ];
		var imageSuffix = ".png";
		var skyGeometry = new THREE.CubeGeometry(1000 * gridSize, 1000 * gridSize, 1000 * gridSize);
		var imageURLs = [];
		for ( var i = 0; i < 6; i++)
			imageURLs.push(imagePrefix + directions[i] + imageSuffix);
		var textureCube = THREE.ImageUtils.loadTextureCube(imageURLs);
		var shader = THREE.ShaderLib["cube"];
		shader.uniforms["tCube"].value = textureCube;
		var skyMaterial = new THREE.ShaderMaterial({
			fragmentShader : shader.fragmentShader,
			vertexShader : shader.vertexShader,
			uniforms : shader.uniforms,
			depthWrite : false,
			side : THREE.BackSide
		});
		var skyBox = new THREE.Mesh(skyGeometry, skyMaterial);
		scene.add(skyBox);

		////////////
		// CUSTOM //
		////////////

		document.addEventListener('mousedown', onDocumentMouseDown, false);

		// Create the Earth with nice texture
		var sphereGeo = new THREE.SphereGeometry(radius, 64, 32);
		var colors = THREE.ImageUtils.loadTexture("../lib/images/earth-day.jpg");
		var earthMaterial = new THREE.MeshBasicMaterial({
			color : 0xffffff,
			map : colors,
			transparent : true,
			opacity : 0.8
		});
		this.earthSphere = new THREE.Mesh(sphereGeo, earthMaterial);
		scene.add(earthSphere);

		var jsonLoader = new THREE.JSONLoader();
		jsonLoader.load("../models/triana.json", addModelToScene);

		makeGrid(scene, true, gridSize);

		// create a set of coordinate axes to help orient user
		//    specify length in pixels in each direction
		//var axes = new THREE.AxisHelper(gridSize);
		//scene.add(axes);
		//makeAxisLabel(scene, true);

	}

	function addModelToScene(geometry, materials) {
		var material = new THREE.MeshFaceMaterial(materials);
		satellite = new THREE.Mesh(geometry, material);
		satellite.scale.set(satScale, satScale, satScale);
		//satellite.position.set(0, 30, 0);

		// 		z = 1126.5079268573745;
		// 		y = 3989.067891143869;
		// 		x = 7340.005746153715;
		// 		satellite.position.set(y, z, x);

		scene.add(satellite);
	}

	function zUp(x, y, z) {
		zUpVec[0] = y;
		zUpVec[1] = z;
		zUpVec[2] = x;
		return;
	}

	function onDocumentMouseDown(event) {
		//console.log("Click.");

		controls.autoRotate = false;
		parameters.autoRotate = false;
		// Iterate over all controllers
		for ( var i in gui.__controllers) {
			gui.__controllers[i].updateDisplay();
		}
	}

	function animate() {
		requestAnimationFrame(animate);
		render();
		update();
	}

	function update() {
		if (keyboard.pressed("z")) {
			// do something
		}

		//earthSphere.rotation.y += 0.0010;
		controls.update();
		stats.update();
	}

	function render() {
		renderer.render(scene, camera);
	}

	function makeOrbit() {
		//console.log("clicked");
		var SemimajorAxis = parameters.a;
		var Eccentricity = parameters.ecc;
		var Inclination = parameters.inc;
		var raan = parameters.raan;
		var w = parameters.w;
		var ta = parameters.ta;
		//console.log("SemimajorAxis=" + SemimajorAxis);

		$.post('/JATServlet/TwoBodyParam', {
			SemimajorAxis : SemimajorAxis,
			Eccentricity : Eccentricity,
			Inclination : Inclination,
			raan : raan,
			w : w,
			ta : ta,
		}, function(responseText) {

			var obj = JSON.parse(responseText);
			//printlnMessage('messages', JSON.stringify(obj));
			//printlnMessage('messages', obj.coords.x[0]);
			//printlnMessage('messages', JSON.stringify(obj.TBE));
			console.log(JSON.stringify(obj.TBE));
			console.log(JSON.stringify(obj.pos));

			var lineGeometry = new THREE.Geometry();
			var vertArray = lineGeometry.vertices;
			for ( var i = 0; i < obj.coords.x.length; i++) {
				//point = new THREE.Vector3(obj.coords.x[i], obj.coords.y[i], obj.coords.z[i]);
				point = new THREE.Vector3(obj.coords.y[i], obj.coords.z[i], obj.coords.x[i]);
				vertArray.push(point);
			}
			lineGeometry.computeLineDistances();
			var lineMaterial = new THREE.LineBasicMaterial({
				color : 0xcc0000
			});
			var index = lines.length;
			//console.log("index=" + index);
			lines[index] = new THREE.Line(lineGeometry, lineMaterial);
			scene.add(lines[index]);

			z = 1126.5079268573745;
			y = 3989.067891143869;
			x = 7340.005746153715;

			x = parseInt(obj.pos.x);
			y = parseInt(obj.pos.y);
			z = parseInt(obj.pos.z);
			console.log("x=" + x + " y=" + y);

			satellite.position.set(y, z, x);
			update();
		});
	}

	function clearOrbits() {
		console.log("clearOrbits called");
		for (index = 0; index < lines.length; ++index) {
			console.log(lines[index]);
			scene.remove(lines[index]);
		}

		// 		for (line in lines)
		// 			scene.remove(line);

	}
</script>

</head>
<body onLoad="setup();">
	<div id="infoButton"></div>
	<div id="infoBox" title="Information">
		Java Astrodynamics Toolkit<br>Drag mouse to rotate scene<br>mouse wheel to zoom
	</div>
	<!-- ------------------------------------------------------------ -->

	<div id="ThreeJS" style="position: absolute; left: 0px; top: 0px"></div>

</body>
</html>
